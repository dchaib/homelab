server:
  endpoints:
    authz:
      forward-auth:
        implementation: 'ForwardAuth'

authentication_backend:
  password_reset:
    disable: true
  password_change:
    disable: true
  file:
    path: '/config/users.yml'

access_control:
  default_policy: deny
  rules:
    - domain:
        - '{{ homelab_services.healthchecks.domain }}'
      resources:
        - '^/ping/.*$'
      policy: bypass
    - domain:
        - '{{ homelab_services.apprise.domain }}'
      policy: one_factor
      subject:
        - ['group:apprise', 'group:service']
    - domain: '*.{{ homelab_domain_name }}'
      policy: two_factor

identity_providers:
  oidc:
    jwks:
      - key: {{ '{{' }} secret "/config/secrets/oidc/jwks/rsa.2048.key" | mindent 10 "|" | msquote {{ '}}' }}
    claims_policies:
      grafana:
        id_token: ['email', 'name', 'groups', 'preferred_username']
    clients:
      - client_id: '{{ auth_oidc_clients.grafana.client_id }}'
        client_name: 'Grafana'
        client_secret: '{{ auth_oidc_clients.grafana.client_digest }}'
        public: false
        authorization_policy: 'two_factor'
        claims_policy: 'grafana'
        require_pkce: true
        pkce_challenge_method: 'S256'
        redirect_uris:
          - 'https://{{ homelab_services.grafana.domain }}/login/generic_oauth'
        scopes:
          - 'openid'
          - 'profile'
          - 'groups'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'
      - client_id: '{{ auth_oidc_clients.paperless_ngx.client_id }}'
        client_name: 'Paperless NGX'
        client_secret: '{{ auth_oidc_clients.paperless_ngx.client_digest }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: true
        pkce_challenge_method: 'S256'
        redirect_uris:
          - 'https://{{ homelab_services.paperless_ngx.domain }}/accounts/oidc/authelia/login/callback/'
        scopes:
          - 'openid'
          - 'profile'
          - 'email'
          - 'groups'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'

session:
  cookies:
    - domain: '{{ homelab_domain_name }}'
      authelia_url: 'https://{{ homelab_services.authelia.domain }}'
  redis:
    host: 'authelia_redis'
    port: 6379

storage:
  local:
    path: /data/db.sqlite3

notifier:
  smtp:
    address: 'smtp://{{ authelia_smtp.server }}:{{ authelia_smtp.port }}'
    username: {{ authelia_smtp.username }}
    sender: {{ authelia_smtp.sender }}

telemetry:
  metrics:
    enabled: true
