---
- name: Prompt for the QR code
  ansible.builtin.pause:
    prompt: "Please enter your QR code"
  register: qr_code
  
- name: Prompt for the PIN
  ansible.builtin.pause:
    prompt: "Please enter your PIN"
  register: pin

- name: Run Docker container to generate credentials
  ansible.builtin.command: >
    docker run --rm -q ghcr.io/dchaib/pronote2calendar:0.2.1 init
    --qr_code '{{ qr_code.user_input }}'
    --pin '{{ pin.user_input }}'
  register: docker_output
  become: true

- name: Validate that the Docker output is valid JSON
  block:
    - name: Try to parse Docker output as JSON
      set_fact:
        parsed_credentials: "{{ docker_output.stdout | from_json }}"
  rescue:
    - name: Fail explicitly if output is invalid JSON
      ansible.builtin.fail:
        msg: >
          The Docker output was not valid JSON. Raw output:
          {{ docker_output.stdout }}

- name: Save the credentials to file
  ansible.builtin.copy:
    content: "{{ docker_output.stdout }}"
    dest: "{{ credentials_file_path }}"
    owner: "{{ users.app_user.name }}"
    group: "{{ users.app_user.group }}"
    mode: '0640'
  become: true
