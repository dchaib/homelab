---
- name: Prompt for the QR code
  ansible.builtin.pause:
    prompt: "Please enter your QR code"
  register: pronote2calendar_qr_code

- name: Prompt for the PIN
  ansible.builtin.pause:
    prompt: "Please enter your PIN"
  register: pronote2calendar_pin

- name: Run Docker container to generate credentials
  ansible.builtin.command: >
    docker run --rm -q ghcr.io/dchaib/pronote2calendar:0.2.1 init
    --qr_code '{{ pronote2calendar_qr_code.user_input }}'
    --pin '{{ pronote2calendar_pin.user_input }}'
  register: pronote2calendar_docker_output
  changed_when: true
  become: true

- name: Validate that the Docker output is valid JSON
  block:
    - name: Try to parse Docker output as JSON
      ansible.builtin.set_fact:
        pronote2calendar_parsed_credentials: "{{ pronote2calendar_docker_output.stdout | from_json }}"
  rescue:
    - name: Fail explicitly if output is invalid JSON
      ansible.builtin.fail:
        msg: >
          The Docker output was not valid JSON. Raw output:
          {{ pronote2calendar_docker_output.stdout }}

- name: Save the credentials to file
  ansible.builtin.copy:
    content: "{{ pronote2calendar_docker_output.stdout }}"
    dest: "{{ credentials_file_path }}"
    owner: "{{ users.app_user.name }}"
    group: "{{ users.app_user.group }}"
    mode: '0640'
  become: true
